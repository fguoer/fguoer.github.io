<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Trimester 2 report</title>
    <script src="../js/madres_schedule_functions.js"> </script>
    <script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.11/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.11/js/jquery.dataTables.js"></script>
</head>

<body>
<h1>MADRES Trimester 2 report</h1>
<p>The reference date (refDate) you selected is <span id="refDate"></span></p>
<input type="button" id="download" value="Download Report" onclick=download() />

<script type="text/javascript">
refDay = getCookie("refDay");
document.getElementById("refDate").innerHTML = refDay;
schedule = JSON.parse(getCookie("schedule"));
// add new variable to the schedule
schedule[0].push.apply(schedule[0], ["Tr2_inWindow", "Tr2_Ques", "GestAge"]);
header = schedule[0];
for (var i = 1; i < schedule.length; i++) {
    if (schedule[i][header.indexOf("Tr2_PSE")]=="" && schedule[i][header.indexOf("Tr2_DadInfo")]=="") {schedule[i][header.indexOf("Tr2_Ques")]="neverStarted"}
    if (schedule[i][header.indexOf("Tr2_PSE")]!="" && schedule[i][header.indexOf("Tr2_DadInfo")]=="") {schedule[i][header.indexOf("Tr2_Ques")]="incomplete"}
    if (schedule[i][header.indexOf("Tr2_PSE")]!="" && schedule[i][header.indexOf("Tr2_DadInfo")]!="") {schedule[i][header.indexOf("Tr2_Ques")]="done"}
    // in window for tr2, at least 21 days has passed from visit 2 to reference date, use countDay to convert string to date
    if (
        countDay(schedule[i][header.indexOf("Tr2_Start")], 0).getTime() < countDay(refDay, 0).getTime() &&
        countDay(refDay, 0).getTime() < countDay(schedule[i][header.indexOf("Tr2_End")]).getTime() &&
        countDay(refDay, 0).getTime() > countDay(schedule[i][header.indexOf("Tr1_Anthr")], 21).getTime()
    ) {
        schedule[i][header.indexOf("Tr2_inWindow")]=true;
    } else {
        schedule[i][header.indexOf("Tr2_inWindow")]=false;
    }
    //Gestational Age as of reference date
    if (schedule[i][header.indexOf("DueDate")]!="") {
        schedule[i][header.indexOf("GestAge")] = gestationalAge(countDay(refDay, 0), schedule[i][header.indexOf("DueDate")]);
    }
}
</script>

<div id="tr2_inWindow_needCall" style="display:block;">
    <p>Subjects in trimester 2 call window and never started questionnaire (total = <span id="tr2_inWindow_needCall_num"></span>)</p>
    <p id="tr2_inWindow_needCall_list"></p>
    <table id="tr2_inWindow_needCall_table" class="display" data-order='[[ 0, "asc" ]]' data-page-length='25'>
        <thead>
            <tr>
                <th>Subject ID</th>
                <th>Due Date</th>
                <th>18w0d Date</th>
                <th>27w6d Date</th>
                <th>Gestational Age as of refDate</th>
            </tr>
        </thead>
    </table>
</div>

<script>
// senario 1, subjects in trimester call window and need to complete questions
senario1 = schedule[0]
for (var i = 1; 1 < schedule.length; i++) {
    if (
        schedule[i][header.indexOf("Withdraw")]=="" &&
        schedule[i][header.indexOf("Tr2_Ques")]=="neverStarted" &&
        schedule[i][header.indexOf("Tr2_inWindow")]==true
    ) {
        senario1.push(schedule[i]);
    }
}

document.getElementById("tr2_inWindow_needCall_num").innerHTML = senario1.length - 1;
document.getElementById("tr2_inWindow_needCall_list").innerHTML = for (var i = 1; i < senario1.length; i++) {senario1[i][0]};
tr2_inWindow_needCall_report = [];
for(var i = 0; i < senario1.length; i++) {
    tr2_inWindow_needCall_report.push([senario1[i][header.indexOf("SubjectID")], senario1[i][header.indexOf("DueDate")], senario1[i][header.indexOf("Tr2_Start")], senario1[i][header.indexOf("Tr2_End")], senario1[i][header.indexOf("GestAge")]]);
}


$(document).ready(function(){
    $("#tr2_inWindow_needCall_table").DataTable({
        paging: true,
        data: tr2_inWindow_needCall_report.shift(), //remove the header
        "columns": [
            {className: "dt-body-center" },
            {className: "dt-body-center" },
            {className: "dt-body-center" },
            {className: "dt-body-center" },
            {className: "dt-body-center" }
        ]
    });
});

</script>



</body>
</html>
