<!DOCTYPE html>
<html>

<head>
<!--
<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
-->
<script src="./js/papaparse.min.js"> </script>
<script src="https://code.jquery.com/jquery-2.2.3.min.js" charset="utf-8"> </script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.11/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.11/js/jquery.dataTables.js"></script>
</head>

<body>
<h1>MADRES Call Schedule</h1>

<p id="today"></p>
<input type="file" id="fileUpload" />
<input type="button" id="upload" value="Upload" onclick = "Upload()" />
<p> Process data after the upload </p>
<input type="button" id="Process" value="Process" onclick = "Process ()" />
<p> As of today, the following participants are in their first trimester. </p>
<p id="tr1"></p>
<p> As of today, the following participants are in their second trimester. </p>
<p id="tr2"></p>
<p> As of today, the following participants are in their third trimester. </p>
<p id="tr3"></p>
<p> As of today, the following participants do not have an expected due date. </p>
<p id="noDue"></p>

<table id="indivTrimester" class="display" data-order='[[ 0, "asc" ]]' data-page-length='25'>
    <thead>
        <tr>
            <th>Subject ID</th>
            <th>Due Date 1</th>
            <th>Due Date 2</th>
            <th>Tr1/Tr2 Cutoff</th>
            <th>Tr2/Tr3 Cutoff</th>
        </tr>
    </thead>
</table>

<script type="text/javascript">
today = new Date();
document.getElementById("today").innerHTML = "Today is " + today.toString();

function Upload() {
    var fileUpload = document.getElementById("fileUpload");
    var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
    if (regex.test(fileUpload.value.toLowerCase())) {
        if (typeof (FileReader) != "undefined") {
            var reader = new FileReader();
            reader.readAsText(fileUpload.files[0]);
            reader.onload = loadHandler;
            function loadHandler(event) {
                var csv = event.target.result;
                output = Papa.parse(csv);
            }
        } else {
            alert("This browser does not support HTML5.");
        }
    } else {
        alert("Please upload a valid CSV file.");
    }
}

function Process() {
    s02_duedate = output.data[0].indexOf("s02_duedate");
    q01_duedate = output.data[0].indexOf("q01_duedate");
    family_id = [];
    for (i = 0; i < output.data.length; i++) {
        family_id.push(output.data[i][0]);
    }

    function unique(list) {
      var result = [];
      $.each(list, function(j, e) {
        if ($.inArray(e, result) == -1) result.push(e);
      });
      return result;
    }
    indivList = unique(family_id);

    scheduleTemp = [];
    for (i = 0; i < output.data.length; i++) {
        scheduleTemp.push([output.data[i][0], output.data[i][s02_duedate], output.data[i][q01_duedate]]);
    }

    function getAllIndexes(arr, val) {
        var indexes = [];
        for(j = 0; j < arr.length; j++) {
            if (arr[j] === val) {indexes.push(j)};
        }
        return indexes;
    }

    schedule = [];
    for (i = 1; i < indivList.length; i++) {
        if (indivList[i] == "") {continue};
        entryX = [indivList[i], "", "", "", "", "", ""];
        $.each(getAllIndexes(family_id, indivList[i]), function(j, e) {
            if (scheduleTemp[e][1] != "") {entryX[1] = scheduleTemp[e][1]};
            if (scheduleTemp[e][2] != "") {entryX[2] = scheduleTemp[e][2]};
        });
        schedule.push(entryX);
    }

    function trimester(date, num) {
        Date.prototype.addDays=function(d){return new Date(this.valueOf()+864E5*d)};
        var dueString = date.split("-");
        dueDate = new Date(dueString[0], dueString[1]-1, dueString[2]);
        predict = new Date(dueDate.addDays(num));
        return(predict);
    }
    function dateCut(x) {
        return(x.getFullYear()+"-"+(x.getMonth()+1)+"-"+x.getDate());
    }
    noDueDate = [];
    trimester1 = [];
    trimester2 = [];
    trimester3 = [];

    for (i = 0; i < schedule.length; i++) {
        if (schedule[i][2] != "") {
            dueDateX = schedule[i][2];
        } else {
            dueDateX = schedule[i][1];
        }
        if (dueDateX != "") {
            schedule[i][3] = trimester(dueDateX, -195);
            schedule[i][5] = dateCut(schedule[i][3]);
            schedule[i][4] = trimester(dueDateX, -84);
            schedule[i][6] = dateCut(schedule[i][4]);
            if (today.getTime() < schedule[i][3].getTime()) {
                trimester1.push(schedule[i][0]);
            } else if (schedule[i][3].getTime() < today.getTime() && today.getTime() < schedule[i][4].getTime()) {
                trimester2.push(schedule[i][0]);
            } else if (schedule[i][4].getTime() < today.getTime()) {
                trimester3.push(schedule[i][0]);
            } else {
                noDueDate.push(schedule[i][0]);
            }
        } else {
            noDueDate.push(schedule[i][0]);
        }
    }
    document.getElementById("tr1").innerHTML = trimester1;
    document.getElementById("tr2").innerHTML = trimester2;
    document.getElementById("tr3").innerHTML = trimester3;
    document.getElementById("noDue").innerHTML = noDueDate;

    report = [];
    for (i = 0; i < schedule.length; i++) {
        report.push([schedule[i][0], schedule[i][1], schedule[i][2], schedule[i][5], schedule[i][6]]);
    }

    $(document).ready(function(){
        $("#indivTrimester").DataTable({
            paging: true,
            data: report,
            "columns": [
                {className: "dt-body-center" },
                {className: "dt-body-center" },
                {className: "dt-body-center" },
                {className: "dt-body-center" },
                {className: "dt-body-center" }]
        });
    });
}
</script>

</body>
</html>
